# ğŸŒ¾ å†œä¸šæ•°æ®é›†æˆç³»ç»Ÿ

ä¸€ä¸ªç”¨äºè¿æ¥å¤–éƒ¨å†œä¸šå¹³å°å’Œ Magistrala IoT å¹³å°çš„æ™ºèƒ½æ•°æ®é›†æˆæœåŠ¡ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¯åŠ¨](#å¿«é€Ÿå¯åŠ¨)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [å®Œæ•´æµç¨‹](#å®Œæ•´æµç¨‹)
- [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
- [ä¸»è¦åŠŸèƒ½](#ä¸»è¦åŠŸèƒ½)
- [API æ¥å£](#api-æ¥å£)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. ç¼–è¯‘
```bash
cd /home/liar/Magistrala/agriDataIntegration
go build -o agri-integration
```

### 2. è¿è¡Œ
```bash
./agri-integration
```

è¯·å…ˆåˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ `config.json`ï¼Œå¡«å†™æ­£ç¡®ä¿¡æ¯åè¿è¡Œã€‚

### 3. é…ç½®æ–‡ä»¶ç¤ºä¾‹
```json
{
  "agriPlatform": {
    "baseUrl": "http://www.0531yun.com",
    "username": "your_username",
    "password": "your_password"
  },
  "magistrala": {
    "domainId": "your_domain_id",
    "channelId": "your_channel_id",
    "channelPort": "9005",
    "clientPort": "9006",
    "messagePort": "9011"
  },
  "integration": {
    "syncInterval": 30,
    "mappingFile": "sensor_mapping.json",
    "backgroundImage": "farm_layout.jpg",
    "defaultPartition": "field_1"
  },
  "server": {
    "port": "8889",
    "host": "0.0.0.0"
  }
}
```

### 4. API æ¥å£

æœåŠ¡å¯åŠ¨ååœ¨ 8080 ç«¯å£æä¾›ä»¥ä¸‹æ¥å£ï¼š

- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /api/stats` - è·å–ç»Ÿè®¡ä¿¡æ¯  
- `GET /api/mappings` - è·å–ä¼ æ„Ÿå™¨æ˜ å°„
- `POST /api/refresh` - åˆ·æ–°ä¼ æ„Ÿå™¨æ•°æ®
- `GET /api/config` - è·å–é…ç½®ä¿¡æ¯

```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤–éƒ¨å†œä¸šå¹³å°API     â”‚    â”‚   é›†æˆæœåŠ¡ (8889)    â”‚     â”‚   Magistralaå¹³å°     â”‚
â”‚  www.0531yun.com    â”‚â—„â”€â”€â–ºâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â—„â”€â”€â–º â”‚   localhost:9005/6  â”‚
â”‚                     â”‚    â”‚ â”‚   æ•°æ®åŒæ­¥å¼•æ“    â”‚ â”‚     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚   æ˜ å°„ç®¡ç†å™¨      â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ â”‚   HTTP API      â”‚ â”‚
                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å®Œæ•´æµç¨‹

### 1ï¸âƒ£ æœåŠ¡åˆå§‹åŒ–é˜¶æ®µ

**å…¥å£æ–‡ä»¶**: `cmd/main.go:main()` â†’ `integration_service.go:NewIntegrationService()`

```
ğŸ”§ åˆ›å»ºæœåŠ¡å®ä¾‹ [integration_service.go:NewIntegrationService()]
â”œâ”€â”€ ğŸ“¡ åˆ›å»ºå†œä¸šå¹³å°å®¢æˆ·ç«¯ (PlatformService)
â”‚   â”œâ”€â”€ è°ƒç”¨: platformservice.go:NewPlatformService()
â”‚   â”œâ”€â”€ ç™»å½•: platformservice.go:Login(username, password)
â”‚   â”œâ”€â”€ è·å–Token: HTTP POST /api/auth/login
â”‚   â””â”€â”€ éªŒè¯: è¿”å›JWTä»¤ç‰Œç”¨äºåç»­APIè°ƒç”¨
â”œâ”€â”€ ğŸŒ åˆ›å»º Magistrala å®¢æˆ·ç«¯ (MagistralaClient)
â”‚   â”œâ”€â”€ è°ƒç”¨: magistrala_client.go:NewMagistralaClient()
â”‚   â”œâ”€â”€ é¢‘é“æœåŠ¡ç«¯å£: 9005 (ç”¨äºè¿æ¥æ“ä½œ)
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯æœåŠ¡ç«¯å£: 9006 (ç”¨äºå®¢æˆ·ç«¯CRUD)
â”‚   â””â”€â”€ é…ç½®: è®¾ç½®BaseURLã€UserTokenã€ç«¯å£é…ç½®
â”œâ”€â”€ ğŸ“‚ åˆ›å»ºæ˜ å°„ç®¡ç†å™¨ (MappingManager)
â”‚   â”œâ”€â”€ è°ƒç”¨: mapping.go:NewMappingManager()
â”‚   â”œâ”€â”€ åŠ è½½: mapping.go:LoadFromFile()
â”‚   â”œâ”€â”€ æ–‡ä»¶: sensor_mapping.json
â”‚   â””â”€â”€ åˆå§‹åŒ–: åˆ›å»ºç©ºæ˜ å°„mapæˆ–åŠ è½½ç°æœ‰æ•°æ®
â””â”€â”€ âš™ï¸ åˆå§‹åŒ–è¿è¡Œæ§åˆ¶
    â”œâ”€â”€ context.WithCancel() åˆ›å»ºä¸Šä¸‹æ–‡
    â”œâ”€â”€ sync.WaitGroup åç¨‹åŒæ­¥
    â””â”€â”€ ç»Ÿè®¡ä¿¡æ¯ç»“æ„ä½“åˆå§‹åŒ–
```

### 2ï¸âƒ£ æœåŠ¡å¯åŠ¨é˜¶æ®µ

**å…¥å£å‡½æ•°**: `integration_service.go:Start()`

```
ğŸš€ å¯åŠ¨é›†æˆæœåŠ¡ [integration_service.go:Start()]
â”œâ”€â”€ âœ… çŠ¶æ€æ£€æŸ¥
â”‚   â”œâ”€â”€ æ£€æŸ¥: is.isRunning é˜²æ­¢é‡å¤å¯åŠ¨
â”‚   â”œâ”€â”€ è®¾ç½®: is.isRunning = true
â”‚   â””â”€â”€ äº’æ–¥é”: is.mu.Lock/Unlock() ä¿è¯çº¿ç¨‹å®‰å…¨
â”œâ”€â”€ ğŸ” ä¼ æ„Ÿå™¨å‘ç°å’Œæ˜ å°„
â”‚   â”œâ”€â”€ è°ƒç”¨: integration_service.go:discoverAndMapSensors()
â”‚   â”œâ”€â”€ ç›®çš„: å»ºç«‹ä¼ æ„Ÿå™¨ä¸Magistralaå®¢æˆ·ç«¯çš„æ˜ å°„å…³ç³»
â”‚   â””â”€â”€ ç»“æœ: åˆ›å»º/æ›´æ–°sensor_mapping.jsonæ–‡ä»¶
â”œâ”€â”€ â° å¯åŠ¨HTTP APIæœåŠ¡å™¨
â”‚   â”œâ”€â”€ è°ƒç”¨: cmd/main.goä¸­çš„HTTPæœåŠ¡å™¨
â”‚   â”œâ”€â”€ ç«¯å£: é…ç½®æ–‡ä»¶ä¸­çš„server.port (é»˜è®¤8889)
â”‚   â””â”€â”€ è·¯ç”±: /health, /api/stats, /api/mappingsç­‰
â””â”€â”€ ğŸ”„ å¯åŠ¨æ•°æ®åŒæ­¥å¾ªç¯
    â”œâ”€â”€ åç¨‹: go is.dataSyncLoop()
    â”œâ”€â”€ é—´éš”: é…ç½®æ–‡ä»¶ä¸­çš„syncInterval (é»˜è®¤30ç§’)
    â””â”€â”€ ä¸Šä¸‹æ–‡: ä½¿ç”¨is.ctxæ§åˆ¶ç”Ÿå‘½å‘¨æœŸ
```

### 3ï¸âƒ£ ä¼ æ„Ÿå™¨å‘ç°ä¸æ˜ å°„é˜¶æ®µ (`discoverAndMapSensors`)

#### ğŸ“Š 3.1 æ•°æ®é‡‡é›†ä¸åˆ†ç±»

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:discoverAndMapSensors()`

```
ğŸŒ ä»å†œä¸šå¹³å°è·å–è®¾å¤‡ä¿¡æ¯
â”œâ”€â”€ ğŸ“¡ è·å–è®¾å¤‡åˆ—è¡¨
â”‚   â”œâ”€â”€ è°ƒç”¨: platformservice.go:GetDeviceList("")
â”‚   â”œâ”€â”€ API: GET /api/device/list
â”‚   â”œâ”€â”€ è®¤è¯: ä½¿ç”¨ç™»å½•æ—¶è·å–çš„Token
â”‚   â””â”€â”€ è¿”å›: []Device è®¾å¤‡åˆ—è¡¨
â”œâ”€â”€ ğŸ”¢ ç»Ÿè®¡å’Œéå†
â”‚   â”œâ”€â”€ åˆå§‹åŒ–: is.stats.TotalSensors = 0
â”‚   â”œâ”€â”€ å¤–å¾ªç¯: for _, device := range devices
â”‚   â””â”€â”€ å†…å¾ªç¯: for _, factor := range device.Factors
â”œâ”€â”€ ğŸ“ å› å­ç­›é€‰å’Œåˆ†ç±»
â”‚   â”œâ”€â”€ è¿‡æ»¤: if !factor.Enabled { continue }
â”‚   â”œâ”€â”€ è®¡æ•°: is.stats.TotalSensors++
â”‚   â””â”€â”€ ç›‘æµ‹å› å­ç±»å‹:
â”‚       â”œâ”€â”€ åœŸå£¤ä¼ æ„Ÿå™¨: åœŸå£¤æ°´åˆ†(%)ã€åœŸå£¤æ¸©åº¦(Â°C)
â”‚       â”œâ”€â”€ æ°”è±¡ä¼ æ„Ÿå™¨: é£å‘(Â°)ã€é£é€Ÿ(m/s)ã€é£åŠ›çº§åˆ«
â”‚       â”œâ”€â”€ ç¯å¢ƒä¼ æ„Ÿå™¨: å¤§æ°”å‹(kPa)ã€CO2æµ“åº¦(ppm)
â”‚       â””â”€â”€ ç©ºæ°”ä¼ æ„Ÿå™¨: ç©ºæ°”æ¹¿åº¦(%)ã€ç©ºæ°”æ¸©åº¦(Â°C)
â””â”€â”€ ğŸ—‚ï¸ æ˜ å°„æ£€æŸ¥å’Œåˆ›å»º
    â”œâ”€â”€ æ£€æŸ¥: mapping.go:GetMapping(deviceAddr, nodeId, registerId)
    â”œâ”€â”€ é”®å€¼: generateKey() ç”Ÿæˆå”¯ä¸€æ ‡è¯† "deviceAddr_nodeId_registerId"
    â””â”€â”€ æ–°å»º: å¦‚ä¸å­˜åœ¨åˆ™åˆ›å»ºSensorMappingç»“æ„ä½“
```

#### ğŸ·ï¸ 3.2 çŠ¶æ€è¯†åˆ«ä¸åˆ†ç±»

**ç›¸å…³ä»£ç **: `integration_service.go:discoverAndMapSensors()` ä¸­çš„çŠ¶æ€åˆ†ç±»é€»è¾‘

```
ğŸ“‚ æ ¹æ®æ˜ å°„æ–‡ä»¶ä¸­çš„çŠ¶æ€è¿›è¡Œæ™ºèƒ½åˆ†ç±»
â”œâ”€â”€ ğŸ†• StatusNotCreated â†’ needCreate[]
â”‚   â”œâ”€â”€ æ¡ä»¶: mapping.Status == StatusNotCreated
â”‚   â”œâ”€â”€ å®šä¹‰: mapping.go ä¸­çš„å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ å«ä¹‰: ä¼ æ„Ÿå™¨åœ¨ Magistrala ä¸­æ— å¯¹åº”å®¢æˆ·ç«¯
â”‚   â””â”€â”€ æ“ä½œ: needCreate = append(needCreate, mapping)
â”œâ”€â”€ ğŸ”— StatusCreated â†’ needConnect[]
â”‚   â”œâ”€â”€ æ¡ä»¶: mapping.Status == StatusCreated
â”‚   â”œâ”€â”€ å«ä¹‰: å®¢æˆ·ç«¯å·²åˆ›å»ºä½†æœªè¿æ¥åˆ°é¢‘é“
â”‚   â”œâ”€â”€ æ£€æŸ¥: mapping.ClientID != "" ä½†æœªè¿æ¥
â”‚   â””â”€â”€ æ“ä½œ: needConnect = append(needConnect, mapping)
â”œâ”€â”€ âœ… StatusConnected â†’ alreadyConnected[]
â”‚   â”œâ”€â”€ æ¡ä»¶: mapping.Status == StatusConnected
â”‚   â”œâ”€â”€ å«ä¹‰: å®¢æˆ·ç«¯å·²åˆ›å»ºä¸”å·²è¿æ¥ (æ­£å¸¸å·¥ä½œçŠ¶æ€)
â”‚   â”œâ”€â”€ æ ‡å¿—: mapping.IsActive == true
â”‚   â””â”€â”€ æ“ä½œ: alreadyConnected = append(alreadyConnected, mapping)
â”œâ”€â”€ âŒ StatusError/StatusUnknown â†’ needCheck[]
â”‚   â”œâ”€â”€ æ¡ä»¶: mapping.Status == StatusError || StatusUnknown
â”‚   â”œâ”€â”€ æ£€æŸ¥: if mapping.RetryCount < 3
â”‚   â”œâ”€â”€ å«ä¹‰: åˆ›å»ºæˆ–è¿æ¥å‡ºé”™ï¼Œéœ€è¦é‡æ–°å°è¯•
â”‚   â””â”€â”€ æ“ä½œ: needCheck = append(needCheck, mapping)
â””â”€â”€ ğŸš« é‡è¯•ä¸Šé™å¤„ç†
    â”œâ”€â”€ æ¡ä»¶: mapping.RetryCount >= 3
    â”œâ”€â”€ æ—¥å¿—: log.Printf("âš ï¸ ä¼ æ„Ÿå™¨ %s é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè·³è¿‡å¤„ç†")
    â””â”€â”€ æ“ä½œ: continue (è·³è¿‡æœ¬æ¬¡å¤„ç†)
```

#### ğŸ”¨ 3.3 å®¢æˆ·ç«¯åˆ›å»ºé˜¶æ®µ

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:createSensorClient()` 

```
ğŸ­ ä¸º needCreate[] ä¸­çš„ä¼ æ„Ÿå™¨åˆ›å»º Magistrala å®¢æˆ·ç«¯
â”œâ”€â”€ ğŸ“ åˆ†é…åˆ†åŒºå’Œä½ç½®ä¿¡æ¯
â”‚   â”œâ”€â”€ è°ƒç”¨: integration_service.go:assignPartitionAndPosition()
â”‚   â”œâ”€â”€ è¿›ä¸€æ­¥è°ƒç”¨: magistrala_client.go:AssignPartitionPosition()
â”‚   â”œâ”€â”€ é»˜è®¤åˆ†åŒº: mapping.Partition = "field_1"
â”‚   â”œâ”€â”€ ä½ç½®åˆ†é…: mapping.Position.X = 100.0, mapping.Position.Y = 100.0
â”‚   â””â”€â”€ ç®—æ³•: æ ¹æ®ä¼ æ„Ÿå™¨ç´¢å¼•è®¡ç®—ç½‘æ ¼ä½ç½®
â”œâ”€â”€ ğŸ†” è°ƒç”¨ Magistrala API åˆ›å»ºå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ å‡½æ•°: magistrala_client.go:CreateMagistralaClientFromSensor()
â”‚   â”œâ”€â”€ æ„é€ è¯·æ±‚: magistrala_client.go:ClientRequest ç»“æ„ä½“
â”‚   â”œâ”€â”€ APIè°ƒç”¨: magistrala_client.go:CreateClient()
â”‚   â”œâ”€â”€ HTTPè¯·æ±‚: POST http://localhost:9006/{domainID}/clients
â”‚   â”œâ”€â”€ è¯·æ±‚å¤´: Authorization: Bearer {userToken}
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯å‘½åè§„åˆ™: "sensor-{å› å­å}-{èŠ‚ç‚¹ID}-{å¯„å­˜å™¨ID}"
â”‚   â””â”€â”€ å…ƒæ•°æ®: åŒ…å«è®¾å¤‡åœ°å€ã€èŠ‚ç‚¹IDã€å› å­ä¿¡æ¯ç­‰
â”œâ”€â”€ ğŸ’¾ æ›´æ–°æ˜ å°„ä¿¡æ¯
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯ID: mapping.ClientID = client.ID
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯åç§°: mapping.ClientName = client.Name  
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯å¯†é’¥: mapping.ClientSecret = client.Credentials["secret"]
â”‚   â”œâ”€â”€ çŠ¶æ€æ›´æ–°: mapping.Status = StatusCreated
â”‚   â””â”€â”€ æ—¶é—´æˆ³: mapping.StatusUpdated = time.Now().Unix()
â””â”€â”€ ğŸ“ æ·»åŠ åˆ°è¿æ¥é˜Ÿåˆ—
    â”œâ”€â”€ æ“ä½œ: needConnect = append(needConnect, mapping)
    â”œâ”€â”€ æ—¥å¿—: log.Printf("âœ… åˆ›å»ºæˆåŠŸ: %s", mapping.ClientID)
    â””â”€â”€ å‡†å¤‡: ç­‰å¾…æ‰¹é‡è¿æ¥é˜¶æ®µå¤„ç†
```

#### ğŸ”— 3.4 æ‰¹é‡è¿æ¥é˜¶æ®µ

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:batchConnectSensors()`

```
ğŸŒ æ‰¹é‡è¿æ¥å®¢æˆ·ç«¯åˆ°é¢‘é“
â”œâ”€â”€ ğŸ“‹ åˆå¹¶è¿æ¥åˆ—è¡¨
â”‚   â”œâ”€â”€ ä»£ç : allToConnect := append(needConnect, needCheck...)
â”‚   â”œâ”€â”€ ç›®çš„: å°†æ–°åˆ›å»ºå’Œéœ€é‡è¯•çš„å®¢æˆ·ç«¯åˆå¹¶å¤„ç†
â”‚   â””â”€â”€ æ—¥å¿—: log.Printf("ğŸ”— å¼€å§‹è¿æ¥ %d ä¸ªå®¢æˆ·ç«¯åˆ°é¢‘é“...")
â”œâ”€â”€ ğŸ”— æ‰§è¡Œæ‰¹é‡è¿æ¥
â”‚   â”œâ”€â”€ å‡½æ•°: integration_service.go:batchConnectSensors()
â”‚   â”œâ”€â”€ éå†: for _, mapping := range mappings
â”‚   â”œâ”€â”€ å•ä¸ªè¿æ¥: magistrala_client.go:ConnectToChannel()
â”‚   â”œâ”€â”€ HTTPè¯·æ±‚: POST http://localhost:9005/{domainID}/channels/connect
â”‚   â”œâ”€â”€ è¯·æ±‚ä½“: {
â”‚   â”‚   "channel_ids": [channelID],
â”‚   â”‚   "client_ids": [clientID],  
â”‚   â”‚   "types": ["publish", "subscribe"]
â”‚   â”‚ }
â”‚   â”œâ”€â”€ è¯·æ±‚å¤´: Authorization: Bearer {userToken}
â”‚   â””â”€â”€ è¶…æ—¶: 10ç§’HTTPå®¢æˆ·ç«¯è¶…æ—¶
â”œâ”€â”€ âœ… è¿æ¥æˆåŠŸå¤„ç†
â”‚   â”œâ”€â”€ å‡½æ•°: mapping.go:MarkAsConnected()
â”‚   â”œâ”€â”€ çŠ¶æ€: mapping.Status = StatusConnected
â”‚   â”œâ”€â”€ æ¿€æ´»: mapping.IsActive = true
â”‚   â”œâ”€â”€ æ¸…é›¶: mapping.RetryCount = 0
â”‚   â”œâ”€â”€ æ¸…ç©º: mapping.ErrorMessage = ""
â”‚   â”œâ”€â”€ æ—¶é—´: mapping.StatusUpdated = time.Now().Unix()
â”‚   â””â”€â”€ åŒæ­¥: mapping.LastSync = time.Now().Unix()
â”œâ”€â”€ âŒ è¿æ¥å¤±è´¥å¤„ç†
â”‚   â”œâ”€â”€ å‡½æ•°: mapping.go:MarkAsError()
â”‚   â”œâ”€â”€ çŠ¶æ€: mapping.Status = StatusError
â”‚   â”œâ”€â”€ åœç”¨: mapping.IsActive = false
â”‚   â”œâ”€â”€ é”™è¯¯: mapping.ErrorMessage = err.Error()
â”‚   â”œâ”€â”€ é‡è¯•: mapping.RetryCount++
â”‚   â””â”€â”€ æ—¶é—´: mapping.StatusUpdated = time.Now().Unix()
â””â”€â”€ ğŸ’¾ ä¿å­˜æ˜ å°„æ–‡ä»¶
    â”œâ”€â”€ å‡½æ•°: mapping.go:SaveToFile()
    â”œâ”€â”€ æ ¼å¼: JSONæ ¼å¼ä¿å­˜åˆ°sensor_mapping.json
    â”œâ”€â”€ é”å®š: is.mappingManager.SaveToFile() çº¿ç¨‹å®‰å…¨
    â””â”€â”€ æ—¥å¿—: è®°å½•ä¿å­˜æˆåŠŸæˆ–å¤±è´¥ä¿¡æ¯
```

### 4ï¸âƒ£ æ•°æ®åŒæ­¥å¾ªç¯

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:dataSyncLoop()`

```
â° å®šæ—¶æ•°æ®åŒæ­¥ (é»˜è®¤30ç§’é—´éš”) [integration_service.go:dataSyncLoop()]
â”œâ”€â”€ ï¿½ åç¨‹å¯åŠ¨
â”‚   â”œâ”€â”€ å¯åŠ¨: go is.dataSyncLoop() 
â”‚   â”œâ”€â”€ WaitGroup: is.wg.Add(1) / defer is.wg.Done()
â”‚   â”œâ”€â”€ ä¸Šä¸‹æ–‡: ç›‘å¬is.ctx.Done()ç”¨äºä¼˜é›…é€€å‡º
â”‚   â””â”€â”€ æ—¥å¿—: log.Println("Data sync loop started")
â”œâ”€â”€ â±ï¸ å®šæ—¶å™¨è®¾ç½®
â”‚   â”œâ”€â”€ åˆ›å»º: ticker := time.NewTicker(syncInterval * time.Second)
â”‚   â”œâ”€â”€ é…ç½®: config.Integration.SyncInterval (é»˜è®¤30ç§’)
â”‚   â”œâ”€â”€ æ¸…ç†: defer ticker.Stop()
â”‚   â””â”€â”€ é€šé“: ç›‘å¬ticker.Cå®šæ—¶ä¿¡å·
â”œâ”€â”€ ğŸ”„ ä¸»å¾ªç¯é€»è¾‘
â”‚   â”œâ”€â”€ selectè¯­å¥: ç›‘å¬å¤šä¸ªé€šé“
â”‚   â”œâ”€â”€ case <-ticker.C: å®šæ—¶å™¨è§¦å‘
â”‚   â”œâ”€â”€ case <-is.ctx.Done(): æ”¶åˆ°åœæ­¢ä¿¡å·
â”‚   â””â”€â”€ default: éé˜»å¡æ£€æŸ¥
â”œâ”€â”€ ğŸ“¡ æ‰§è¡Œæ•°æ®åŒæ­¥
â”‚   â”œâ”€â”€ è°ƒç”¨: integration_service.go:syncData()
â”‚   â”œâ”€â”€ é”™è¯¯å¤„ç†: æ•è·å¹¶è®°å½•åŒæ­¥é”™è¯¯
â”‚   â”œâ”€â”€ ç»Ÿè®¡æ›´æ–°: is.stats.SyncErrors++ æˆ–æˆåŠŸè®¡æ•°
â”‚   â””â”€â”€ æ—¶é—´è®°å½•: is.stats.LastSync = time.Now().Unix()
â”œâ”€â”€ ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤
â”‚   â”œâ”€â”€ æˆåŠŸ: æ¸…ç©ºis.stats.LastError
â”‚   â”œâ”€â”€ å¤±è´¥: is.stats.LastError = err.Error()
â”‚   â”œâ”€â”€ è®¡æ•°: ç»´æŠ¤æˆåŠŸå’Œå¤±è´¥æ¬¡æ•°
â”‚   â””â”€â”€ çº¿ç¨‹å®‰å…¨: is.mu.Lock/Unlockä¿æŠ¤ç»Ÿè®¡æ•°æ®
â””â”€â”€ ï¿½ ä¼˜é›…é€€å‡º
    â”œâ”€â”€ ä¿¡å·: æ”¶åˆ°context.Cancelä¿¡å·
    â”œâ”€â”€ æ¸…ç†: åœæ­¢å®šæ—¶å™¨ï¼Œæ¸…ç†èµ„æº
    â”œâ”€â”€ æ—¥å¿—: log.Println("Data sync loop stopped")
    â””â”€â”€ è¿”å›: åç¨‹å®‰å…¨é€€å‡º
```

### 5ï¸âƒ£ æ•°æ®åŒæ­¥é˜¶æ®µ

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:syncData()`

```
ğŸ“¡ å®é™…æ•°æ®åŒæ­¥æ‰§è¡Œè¿‡ç¨‹ [integration_service.go:syncData()]
â”œâ”€â”€ 1ï¸âƒ£ è·å–æ´»è·ƒä¼ æ„Ÿå™¨æ˜ å°„
â”‚   â”œâ”€â”€ è°ƒç”¨: mapping.go:GetActiveMappings()
â”‚   â”œâ”€â”€ ç­›é€‰: mapping.go:GetMappingsByStatus(StatusConnected)
â”‚   â”œâ”€â”€ æ¡ä»¶: mapping.Status == StatusConnected && mapping.IsActive
â”‚   â”œâ”€â”€ æ£€æŸ¥: if len(mappings) == 0 { return nil }
â”‚   â””â”€â”€ æ—¥å¿—: è®°å½•æ´»è·ƒæ˜ å°„æ•°é‡
â”œâ”€â”€ 2ï¸âƒ£ è·å–å†œä¸šå¹³å°å®æ—¶æ•°æ®
â”‚   â”œâ”€â”€ è°ƒç”¨: platformservice.go:GetRealTimeData("")
â”‚   â”œâ”€â”€ API: GET /api/data/realtime
â”‚   â”œâ”€â”€ è®¤è¯: ä½¿ç”¨Tokenè¿›è¡Œèº«ä»½éªŒè¯
â”‚   â”œâ”€â”€ è¿”å›: []RealTimeData å®æ—¶æ•°æ®æ•°ç»„
â”‚   â”œâ”€â”€ æ£€æŸ¥: if len(realTimeData) == 0 { return nil }
â”‚   â””â”€â”€ æ—¥å¿—: log.Printf("Retrieved %d real-time data records")
â”œâ”€â”€ 3ï¸âƒ£ æ•°æ®å¤„ç†å’Œå‘é€å¾ªç¯
â”‚   â”œâ”€â”€ ğŸ” ä¸‰å±‚åµŒå¥—éå†
â”‚   â”‚   â”œâ”€â”€ å¤–å±‚: for _, data := range realTimeData
â”‚   â”‚   â”œâ”€â”€ ä¸­å±‚: for _, dataItem := range data.DataItem  
â”‚   â”‚   â””â”€â”€ å†…å±‚: for _, registerItem := range dataItem.RegisterItem
â”‚   â”œâ”€â”€ ğŸ¯ æ˜ å°„åŒ¹é…é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ å‡½æ•°: mapping.go:GetMapping(deviceAddr, nodeId, registerId)
â”‚   â”‚   â”œâ”€â”€ é”®å€¼: generateKey(data.DeviceAddr, dataItem.NodeId, registerItem.RegisterId)
â”‚   â”‚   â”œâ”€â”€ æ£€æŸ¥: if !exists || !mapping.IsActive { continue }
â”‚   â”‚   â””â”€â”€ éªŒè¯: ç¡®ä¿æ˜ å°„å­˜åœ¨ä¸”å¤„äºæ´»è·ƒçŠ¶æ€
â”‚   â”œâ”€â”€ ğŸ“¦ æ„é€ æ¶ˆæ¯è½½è·
â”‚   â”‚   â”œâ”€â”€ ç»“æ„ä½“: data.go:MessagePayload
â”‚   â”‚   â”œâ”€â”€ æ—¶é—´æˆ³: payload.Timestamp = data.TimeStamp
â”‚   â”‚   â”œâ”€â”€ è®¾å¤‡ä¿¡æ¯: DeviceAddr, DeviceName, NodeID, RegisterID
â”‚   â”‚   â”œâ”€â”€ ä¼ æ„Ÿå™¨æ•°æ®: Value, Text, Unit, RegisterName, FactorName
â”‚   â”‚   â”œâ”€â”€ æŠ¥è­¦ä¿¡æ¯: AlarmLevel, AlarmInfo
â”‚   â”‚   â”œâ”€â”€ ä½ç½®ä¿¡æ¯: Latitude, Longitude (data.Lat, data.Lng)
â”‚   â”‚   â””â”€â”€ å…ƒæ•°æ®: åˆ†åŒºã€å®¢æˆ·ç«¯IDç­‰
â”‚   â”œâ”€â”€ ğŸ“¤ å‘é€åˆ° Magistrala
â”‚   â”‚   â”œâ”€â”€ å‡½æ•°: magistrala_client.go:SendMessage()
â”‚   â”‚   â”œâ”€â”€ å‚æ•°: channelID, clientSecret, payload
â”‚   â”‚   â”œâ”€â”€ API: POST http://localhost:9005/{channelID}/messages
â”‚   â”‚   â”œâ”€â”€ è®¤è¯: ä½¿ç”¨å®¢æˆ·ç«¯å¯†é’¥è¿›è¡Œè®¤è¯
â”‚   â”‚   â”œâ”€â”€ æ ¼å¼: JSONæ ¼å¼çš„æ¶ˆæ¯è½½è·
â”‚   â”‚   â””â”€â”€ è¶…æ—¶: 10ç§’HTTPè¯·æ±‚è¶…æ—¶
â”‚   â””â”€â”€ ğŸ“Š æ›´æ–°ç»Ÿè®¡å’Œæ˜ å°„
â”‚       â”œâ”€â”€ æ¶ˆæ¯è®¡æ•°: is.stats.MessagesSent++
â”‚       â”œâ”€â”€ æ˜ å°„æ›´æ–°: mapping.go:UpdateMapping()
â”‚       â”œâ”€â”€ æœ€åæ•°å€¼: mapping.LastValue = registerItem.Value
â”‚       â”œâ”€â”€ æœ€åæ—¶é—´: mapping.LastUpdate = time.Now().Unix()
â”‚       â””â”€â”€ çº¿ç¨‹å®‰å…¨: ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®
â””â”€â”€ 4ï¸âƒ£ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
    â”œâ”€â”€ å‘é€å¤±è´¥: è®°å½•é”™è¯¯ä½†ç»§ç»­å¤„ç†å…¶ä»–æ•°æ®
    â”œâ”€â”€ APIé”™è¯¯: åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
    â”œâ”€â”€ é‡è¯•ç­–ç•¥: å¯¹ä¸´æ—¶é”™è¯¯è¿›è¡Œé‡è¯•
    â”œâ”€â”€ ç»Ÿè®¡ç»´æŠ¤: æ›´æ–°æˆåŠŸ/å¤±è´¥è®¡æ•°
    â””â”€â”€ è¯¦ç»†æ—¥å¿—: è®°å½•å¤„ç†çš„æ•°æ®æ¡æ•°å’Œé”™è¯¯ä¿¡æ¯
```

### 6ï¸âƒ£ æœåŠ¡åœæ­¢é˜¶æ®µ

**æ ¸å¿ƒå‡½æ•°**: `integration_service.go:Stop()`

```
â¹ï¸ ä¼˜é›…å…³é—­æœåŠ¡ [integration_service.go:Stop()]
â”œâ”€â”€ ï¿½ çŠ¶æ€æ£€æŸ¥å’Œé”å®š
â”‚   â”œâ”€â”€ äº’æ–¥é”: is.mu.Lock() / defer is.mu.Unlock()
â”‚   â”œâ”€â”€ çŠ¶æ€æ£€æŸ¥: if !is.isRunning { return }
â”‚   â”œâ”€â”€ é˜²é‡å¤: é¿å…é‡å¤è°ƒç”¨Stop()
â”‚   â””â”€â”€ çŠ¶æ€æ›´æ–°: is.isRunning = false
â”œâ”€â”€ ï¿½ğŸ“¤ å‘é€åœæ­¢ä¿¡å·
â”‚   â”œâ”€â”€ ä¸Šä¸‹æ–‡å–æ¶ˆ: is.cancel()
â”‚   â”œâ”€â”€ ä¿¡å·ä¼ æ’­: æ‰€æœ‰ç›‘å¬is.ctx.Done()çš„åç¨‹æ”¶åˆ°ä¿¡å·
â”‚   â”œâ”€â”€ å®šæ—¶å™¨åœæ­¢: dataSyncLoopä¸­çš„tickeråœæ­¢
â”‚   â””â”€â”€ æ—¥å¿—: log.Println("Shutting down service...")
â”œâ”€â”€ â³ ç­‰å¾…åç¨‹å®‰å…¨é€€å‡º
â”‚   â”œâ”€â”€ ç­‰å¾…: is.wg.Wait()
â”‚   â”œâ”€â”€ é˜»å¡: ç›´åˆ°æ‰€æœ‰åç¨‹è°ƒç”¨wg.Done()
â”‚   â”œâ”€â”€ è¶…æ—¶ä¿æŠ¤: å¯é€‰çš„è¶…æ—¶æœºåˆ¶é˜²æ­¢æ— é™ç­‰å¾…
â”‚   â””â”€â”€ æ—¥å¿—: log.Println("All goroutines stopped")
â”œâ”€â”€ ğŸ’¾ ä¿å­˜æœ€ç»ˆçŠ¶æ€
â”‚   â”œâ”€â”€ æ˜ å°„ä¿å­˜: is.mappingManager.SaveToFile()
â”‚   â”œâ”€â”€ æ–‡ä»¶: æœ€ç»ˆçŠ¶æ€å†™å…¥sensor_mapping.json
â”‚   â”œâ”€â”€ ç»Ÿè®¡ä¿å­˜: å¯é€‰çš„ç»Ÿè®¡ä¿¡æ¯æŒä¹…åŒ–
â”‚   â”œâ”€â”€ é”™è¯¯å¤„ç†: ä¿å­˜å¤±è´¥æ—¶è®°å½•é”™è¯¯ä½†ä¸é˜»æ­¢å…³é—­
â”‚   â””â”€â”€ æ—¥å¿—: log.Printf("Mappings saved to %s", mappingFile)
â”œâ”€â”€ ğŸ§¹ èµ„æºæ¸…ç†
â”‚   â”œâ”€â”€ ç½‘ç»œè¿æ¥: å…³é—­HTTPå®¢æˆ·ç«¯è¿æ¥æ± 
â”‚   â”œâ”€â”€ æ–‡ä»¶å¥æŸ„: ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ­£ç¡®å…³é—­
â”‚   â”œâ”€â”€ å†…å­˜æ¸…ç†: æ¸…ç©ºå¤§å‹æ•°æ®ç»“æ„
â”‚   â””â”€â”€ å®šæ—¶å™¨: ç¡®ä¿æ‰€æœ‰å®šæ—¶å™¨è¢«åœæ­¢
â””â”€â”€ ğŸ“ æœ€ç»ˆæ—¥å¿—
    â”œâ”€â”€ æˆåŠŸ: log.Println("Integration service stopped")
    â”œâ”€â”€ ç»Ÿè®¡: è¾“å‡ºæœ€ç»ˆçš„è¿è¡Œç»Ÿè®¡ä¿¡æ¯
    â”œâ”€â”€ æ—¶é—´: è®°å½•æœåŠ¡è¿è¡Œæ€»æ—¶é•¿
    â””â”€â”€ çŠ¶æ€: æ˜¾ç¤ºæœ€ç»ˆçš„ä¼ æ„Ÿå™¨è¿æ¥çŠ¶æ€
```

### ğŸ› ï¸ å…³é”®æ•°æ®ç»“æ„å’Œæ–‡ä»¶

#### ğŸ“ æ ¸å¿ƒæ–‡ä»¶è¯´æ˜
- **`cmd/main.go`**: ç¨‹åºå…¥å£ï¼ŒHTTPæœåŠ¡å™¨ï¼Œä¿¡å·å¤„ç†
- **`integration_service.go`**: æ ¸å¿ƒé›†æˆæœåŠ¡é€»è¾‘
- **`mapping.go`**: ä¼ æ„Ÿå™¨æ˜ å°„ç®¡ç†å’ŒçŠ¶æ€è¿½è¸ª  
- **`magistrala_client.go`**: Magistralaå¹³å°APIå®¢æˆ·ç«¯
- **`platformservice.go`**: å¤–éƒ¨å†œä¸šå¹³å°APIå®¢æˆ·ç«¯
- **`config.go`**: é…ç½®ç®¡ç†å’Œç¯å¢ƒå˜é‡å¤„ç†
- **`data.go`**: æ•°æ®ç»“æ„å®šä¹‰ (MessagePayloadç­‰)

#### ğŸ“Š å…³é”®æ•°æ®ç»“æ„
```go
// ä¼ æ„Ÿå™¨æ˜ å°„ (mapping.go)
type SensorMapping struct {
    DeviceAddr    int          // è®¾å¤‡åœ°å€
    NodeID        int          // èŠ‚ç‚¹ID  
    RegisterID    int          // å¯„å­˜å™¨ID
    ClientID      string       // Magistralaå®¢æˆ·ç«¯ID
    Status        ClientStatus // å®¢æˆ·ç«¯çŠ¶æ€
    RetryCount    int          // é‡è¯•æ¬¡æ•°
    IsActive      bool         // æ˜¯å¦æ´»è·ƒ
    // ... æ›´å¤šå­—æ®µ
}

// æ¶ˆæ¯è½½è· (data.go)  
type MessagePayload struct {
    Timestamp     int64   // æ—¶é—´æˆ³
    DeviceAddr    int     // è®¾å¤‡åœ°å€
    Value         float64 // ä¼ æ„Ÿå™¨æ•°å€¼
    Unit          string  // å•ä½
    AlarmLevel    int     // æŠ¥è­¦çº§åˆ«
    // ... æ›´å¤šå­—æ®µ
}
```

## ğŸ›ï¸ çŠ¶æ€ç®¡ç†

### çŠ¶æ€å®šä¹‰
- **`not_created`**: ä¼ æ„Ÿå™¨æœªåœ¨ Magistrala ä¸­åˆ›å»ºå®¢æˆ·ç«¯
- **`created`**: å®¢æˆ·ç«¯å·²åˆ›å»ºä½†æœªè¿æ¥åˆ°é¢‘é“
- **`connected`**: å®¢æˆ·ç«¯å·²åˆ›å»ºä¸”å·²è¿æ¥ (æ­£å¸¸å·¥ä½œçŠ¶æ€)
- **`error`**: åˆ›å»ºæˆ–è¿æ¥è¿‡ç¨‹ä¸­å‡ºé”™
- **`unknown`**: çŠ¶æ€æœªçŸ¥ï¼Œéœ€è¦é‡æ–°æ£€æŸ¥

### çŠ¶æ€è½¬æ¢æµç¨‹
```
not_created â†’ (åˆ›å»ºå®¢æˆ·ç«¯) â†’ created â†’ (è¿æ¥é¢‘é“) â†’ connected
     â†“                         â†“                    â†“
   error â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ error â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ error
     â†“                         â†“                    â†“
retry (æœ€å¤š3æ¬¡) â†’ not_created / created / connected
```

### æ˜ å°„æ–‡ä»¶ç»“æ„
```json
{
  "40366226_11_1": {
    "deviceAddr": 40366226,
    "deviceName": "40366226",
    "nodeId": 11,
    "registerId": 1,
    "factorName": "ç©ºæ°”æ¸©åº¦",
    "clientId": "client-123",
    "clientName": "sensor-ç©ºæ°”æ¸©åº¦-11-1",
    "status": "connected",
    "statusUpdated": 1696075200,
    "errorMessage": "",
    "retryCount": 0,
    "isActive": true,
    "lastSync": 1696075200,
    "position": {"x": 100.0, "y": 100.0},
    "partition": "field_1"
  }
}
```

## ğŸ“ˆ ä¸»è¦åŠŸèƒ½

- ğŸ”„ **ä¼ æ„Ÿå™¨è‡ªåŠ¨å‘ç°**: æ™ºèƒ½å‘ç°å¤–éƒ¨å¹³å°çš„æ‰€æœ‰ä¼ æ„Ÿå™¨è®¾å¤‡
- ğŸ·ï¸ **çŠ¶æ€ç®¡ç†ç³»ç»Ÿ**: åŸºäºæ˜ å°„æ–‡ä»¶çš„æ™ºèƒ½çŠ¶æ€è·Ÿè¸ªå’Œç®¡ç†
- ğŸš€ **æ‰¹é‡æ“ä½œä¼˜åŒ–**: æ‰¹é‡åˆ›å»ºå®¢æˆ·ç«¯å’Œè¿æ¥ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°
- ğŸ” **æ™ºèƒ½é‡è¯•æœºåˆ¶**: é”™è¯¯ä¼ æ„Ÿå™¨è‡ªåŠ¨é‡è¯•ï¼Œæœ€å¤š3æ¬¡é¿å…æ— é™å¾ªç¯
- ğŸ“¡ **å®æ—¶æ•°æ®åŒæ­¥**: å®šæœŸä»å¤–éƒ¨å¹³å°è·å–å®æ—¶æ•°æ®å¹¶è½¬å‘åˆ° Magistrala
- ğŸ“Š **çŠ¶æ€ç›‘æ§**: æä¾›è¯¦ç»†çš„HTTP APIç›‘æ§é›†æˆçŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯
- ğŸ’¾ **æŒä¹…åŒ–å­˜å‚¨**: æ˜ å°„çŠ¶æ€ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼ŒæœåŠ¡é‡å¯åå¯æ¢å¤

## API æ¥å£

é›†æˆæœåŠ¡æä¾› HTTP API æ¥å£ï¼ˆé»˜è®¤ç«¯å£ 8080ï¼‰ï¼š

### è·å–ç»Ÿè®¡ä¿¡æ¯
```
GET /api/stats
```

è¿”å›é›†æˆæœåŠ¡çš„è¿è¡Œç»Ÿè®¡ä¿¡æ¯ï¼š
- ä¼ æ„Ÿå™¨æ€»æ•°
- æ´»è·ƒæ˜ å°„æ•°é‡  
- å·²å‘é€æ¶ˆæ¯æ•°
- æœ€ååŒæ­¥æ—¶é—´
- é”™è¯¯ä¿¡æ¯ç­‰

### è·å–æ˜ å°„åˆ—è¡¨
```
GET /api/mappings
```

è¿”å›æ‰€æœ‰ä¼ æ„Ÿå™¨ä¸ Magistrala å®¢æˆ·ç«¯çš„æ˜ å°„å…³ç³»ã€‚

### åˆ·æ–°ä¼ æ„Ÿå™¨
```
POST /api/refresh
```

é‡æ–°æ‰«æå¤–éƒ¨å¹³å°çš„ä¼ æ„Ÿå™¨å¹¶æ›´æ–°æ˜ å°„ã€‚

### è·å–é…ç½®ä¿¡æ¯
```
GET /api/config
```

è¿”å›å½“å‰ç³»ç»Ÿé…ç½®ã€‚

### å¥åº·æ£€æŸ¥
```
GET /health
```

æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€ã€‚

## æ•°æ®æµç¨‹

1. **åˆå§‹åŒ–é˜¶æ®µ**:
   - ç™»å½•å¤–éƒ¨å†œä¸šå¹³å°è·å–è®¿é—®ä»¤ç‰Œ
   - æ‰«ææ‰€æœ‰è®¾å¤‡å’Œä¼ æ„Ÿå™¨
   - ä¸ºæ¯ä¸ªä¼ æ„Ÿå™¨åœ¨ Magistrala ä¸­åˆ›å»ºå®¢æˆ·ç«¯
   - å»ºç«‹ä¼ æ„Ÿå™¨åˆ°å®¢æˆ·ç«¯çš„æ˜ å°„å…³ç³»
   - è¿æ¥å®¢æˆ·ç«¯åˆ°æŒ‡å®šé¢‘é“

2. **è¿è¡Œé˜¶æ®µ**:
   - å®šæœŸä»å¤–éƒ¨å¹³å°è·å–å®æ—¶æ•°æ®
   - æ ¹æ®æ˜ å°„å…³ç³»å°†æ•°æ®è½¬å‘åˆ°å¯¹åº”çš„ Magistrala å®¢æˆ·ç«¯
   - æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯

3. **æ•°æ®æ ¼å¼**:
   - æ¶ˆæ¯è½½è·åŒ…å«å®Œæ•´çš„ä¼ æ„Ÿå™¨ä¿¡æ¯å’Œæ•°å€¼
   - æ”¯æŒæŠ¥è­¦çº§åˆ«å’Œä½ç½®ä¿¡æ¯
   - åŒ…å«æ—¶é—´æˆ³å’Œå…ƒæ•°æ®

## æ˜ å°„ç®¡ç†

ä¼ æ„Ÿå™¨æ˜ å°„ä¿¡æ¯ä¿å­˜åœ¨ `sensor_mapping.json` æ–‡ä»¶ä¸­ï¼ŒåŒ…å«ï¼š

- å¤–éƒ¨å¹³å°ä¼ æ„Ÿå™¨æ ‡è¯†ï¼ˆè®¾å¤‡åœ°å€ã€èŠ‚ç‚¹IDã€å¯„å­˜å™¨IDï¼‰
- Magistrala å®¢æˆ·ç«¯ä¿¡æ¯ï¼ˆå®¢æˆ·ç«¯IDã€åç§°ã€å¯†é’¥ï¼‰
- ä½ç½®å’Œåˆ†åŒºä¿¡æ¯
- çŠ¶æ€å’Œç»Ÿè®¡æ•°æ®

æ˜ å°„æ–‡ä»¶ä¼šåœ¨æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨æ›´æ–°å’Œä¿å­˜ã€‚

## ç›‘æ§å’Œç»´æŠ¤

- æŸ¥çœ‹æœåŠ¡æ—¥å¿—äº†è§£è¿è¡ŒçŠ¶æ€
- é€šè¿‡ API æ¥å£ç›‘æ§ç»Ÿè®¡ä¿¡æ¯
- å®šæœŸå¤‡ä»½æ˜ å°„æ–‡ä»¶
- æ ¹æ®éœ€è¦è°ƒæ•´åŒæ­¥é—´éš”

## é›†æˆåˆ° Magistrala UI

é›†æˆæœåŠ¡åˆ›å»ºçš„ä¼ æ„Ÿå™¨å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å‡ºç°åœ¨ Magistrala UI çš„è®¾å¤‡ç®¡ç†ç•Œé¢ä¸­ï¼ŒåŒ…å«ï¼š

- æ­£ç¡®çš„åˆ†åŒºåˆ†é…
- åœ¨åœ°å›¾ä¸Šçš„ä½ç½®æ ‡è®°
- è¯¦ç»†çš„å…ƒæ•°æ®ä¿¡æ¯
- å®æ—¶æ•°æ®æµ

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. 404 é”™è¯¯
```
Failed to create Magistrala client: status 404
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ domainId å’Œ channelId æ˜¯å¦æ­£ç¡®

#### 2. ç«¯å£å ç”¨
```
listen tcp :8889: bind: address already in use
```
**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ config.json ä¸­çš„ç«¯å£é…ç½®

#### 3. è®¤è¯å¤±è´¥
```
status 403
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ userToken æ˜¯å¦æœ‰æ•ˆå’Œæœ‰è¶³å¤Ÿæƒé™

#### 4. ä¼ æ„Ÿå™¨çŠ¶æ€å¼‚å¸¸
**è§£å†³æ–¹æ¡ˆ**: åˆ é™¤ sensor_mapping.json æ–‡ä»¶é‡æ–°è¿è¡Œï¼Œæˆ–è€…è°ƒç”¨ `/refresh` API

#### 5. ç™»å½•å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å†œä¸šå¹³å°çš„ç”¨æˆ·åå’Œå¯†ç 

#### 6. æ•°æ®ä¸æ›´æ–°
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¤–éƒ¨å¹³å°å¯ç”¨æ€§

#### 7. æ˜ å°„ä¸¢å¤±
**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿æ˜ å°„æ–‡ä»¶æœ‰è¯»å†™æƒé™

### æ—¥å¿—çº§åˆ«
- `âœ… æˆåŠŸ` - æ­£å¸¸æ“ä½œ
- `âš ï¸ è­¦å‘Š` - å¯æ¢å¤çš„é”™è¯¯  
- `âŒ é”™è¯¯` - éœ€è¦å¤„ç†çš„é”™è¯¯
- `ğŸ” è°ƒè¯•` - è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯

### å¯åŠ¨æ—¥å¿—ç¤ºä¾‹
```
ğŸŒ¾ å†œä¸šæ•°æ®é›†æˆæœåŠ¡å¯åŠ¨ä¸­...
ğŸ“‹ é…ç½®è¯´æ˜: å¯é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½® Magistrala é…ç½®
âœ… æˆåŠŸç™»å½•å†œä¸šå¹³å°ï¼Œtoken: eyJhbGciOiJIUzI1NiJ9...
ğŸ” å‘ç°ä¼ æ„Ÿå™¨...
ğŸ“Š ä¼ æ„Ÿå™¨çŠ¶æ€ç»Ÿè®¡:
   â€¢ éœ€è¦åˆ›å»º: 9 ä¸ª
   â€¢ éœ€è¦è¿æ¥: 0 ä¸ª  
   â€¢ å·²ç»è¿æ¥: 0 ä¸ª
ğŸ”¨ å¼€å§‹åˆ›å»º 9 ä¸ªæ–°å®¢æˆ·ç«¯...
ğŸ”— å¼€å§‹è¿æ¥ 9 ä¸ªå®¢æˆ·ç«¯åˆ°é¢‘é“...
âœ… æ‰¹é‡è¿æ¥æˆåŠŸ
ğŸš€ HTTP API æœåŠ¡å™¨å¯åŠ¨åœ¨: http://localhost:8889
```

## å¼€å‘å’Œæ‰©å±•

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦ç»„ä»¶ï¼š

- `config.go`: é…ç½®ç®¡ç†
- `mapping.go`: æ˜ å°„å…³ç³»ç®¡ç†  
- `magistrala_client.go`: Magistrala å¹³å°å®¢æˆ·ç«¯
- `integration_service.go`: æ ¸å¿ƒé›†æˆæœåŠ¡
- `cmd/main.go`: ä¸»ç¨‹åºå’Œ HTTP API

å¯æ ¹æ®éœ€è¦æ‰©å±•æ”¯æŒå…¶ä»–å¤–éƒ¨å¹³å°æˆ–æ·»åŠ æ–°çš„åŠŸèƒ½ç‰¹æ€§ã€‚

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **æ‰¹é‡æ“ä½œ**: å‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜å¤„ç†æ•ˆç‡
- **çŠ¶æ€ç¼“å­˜**: é¿å…é‡å¤æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€ï¼ŒåŸºäºæ˜ å°„æ–‡ä»¶æ™ºèƒ½åˆ¤æ–­
- **æ™ºèƒ½é‡è¯•**: é”™è¯¯ä¼ æ„Ÿå™¨è‡ªåŠ¨é‡è¯•ä½†æœ‰ä¸Šé™ï¼Œé¿å…èµ„æºæµªè´¹
- **å¼‚æ­¥å¤„ç†**: æ•°æ®åŒæ­¥ä¸é˜»å¡æœåŠ¡å¯åŠ¨ï¼Œæé«˜ç³»ç»Ÿå“åº”æ€§
- **èµ„æºç®¡ç†**: åç¨‹å®‰å…¨å’Œå†…å­˜ä¼˜åŒ–ï¼Œç¡®ä¿é•¿æœŸç¨³å®šè¿è¡Œ

---

**å¼€å‘è€…**: å†œä¸šIoTé›†æˆå›¢é˜Ÿ  
**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´10æœˆ